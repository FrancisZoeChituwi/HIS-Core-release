{"version":3,"sources":["webpack:///./src/apps/OPD/views/encounters/Dispensing.vue?067c","webpack:///./src/apps/OPD/services/dispensation_service.ts","webpack:///./src/apps/OPD/views/encounters/Dispensing.vue","webpack:///./src/apps/OPD/views/encounters/Dispensing.vue?7377"],"names":["render","_ctx","_cache","$props","$setup","$data","$options","_component_his_standard_form","skipSummary","cancelDestinationPath","cancelDestination","fields","patientID","providerID","drugHistory","currentDrugOrder","this","orderId","quantity","date","dispensations","postJson","getProgramID","void","getDrugOrderHistory","res","getDrugOrders","Promise","all","drug","units","drugOrderBarcodes","barcodes","sort","a","b","tabs","length","i","parseInt","smallestAvailableTab","completePack","mixins","EncounterMixin","data","dispensation","watch","patient","handler","getID","loadCurrentDrugOrder","loadDrugHistory","getFields","deep","methods","saveDispensations","item","buildDispensations","other","order_id","value","buildMedicationHistory","getDrugHistory","dateA","Date","order","start_date","dateB","map","d","medication","name","toStandardHisDisplayFormat","amount","buildOrderOptions","getCurrentOrder","label","drug_id","calculateCompletePack","getPackSizesRows","drugId","availableStock","packs","getDrugPackSizes","packSize","parseFloat","amount_needed","calcCompletePack","isDoneDispensing","orders","o","every","Boolean","isValidDispensation","option","isOk","totalTabs","toString","amountNeeded","percentageGiven","id","helpText","type","TT_DRUG_DISPENSER","onValueUpdate","l","gotoPatientDashboard","onValue","isBarcodeScanned","voidOrder","voided","dispensed","config","medicationHistory","toolbarInfo","getFullName","getGender","getBirthdate","hiddenFooterBtns","options","__exports__"],"mappings":"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","file":"js/chunk-2d0ccf55.291111d0.js","sourcesContent":["import { resolveComponent as _resolveComponent, createVNode as _createVNode, openBlock as _openBlock, createBlock as _createBlock } from \"vue\"\n\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_his_standard_form = _resolveComponent(\"his-standard-form\")\n\n  return (_openBlock(), _createBlock(_component_his_standard_form, {\n    skipSummary: true,\n    cancelDestinationPath: _ctx.cancelDestination,\n    fields: _ctx.fields\n  }, null, 8, [\"cancelDestinationPath\", \"fields\"]))\n}","import { AppEncounterService } from \"@/services/app_encounter_service\";\r\nimport { DrugOrderService } from \"@/services/drug_order_service\";\r\n\r\nexport class DispensationService extends AppEncounterService {\r\n  drugHistory: Array<any>;\r\n  currentDrugOrder: Array<any>;\r\n\r\n  constructor(patientID: number, providerID: number) {\r\n    super(patientID, 54, providerID)\r\n    this.drugHistory = []\r\n    this.currentDrugOrder = []\r\n  }\r\n\r\n  getDrugHistory() {\r\n    return this.drugHistory\r\n  }\r\n\r\n  getCurrentOrder() {\r\n    return this.currentDrugOrder\r\n  }\r\n\r\n  buildDispensations(orderId: number, quantity: number) {\r\n    return [{\r\n      'drug_order_id': orderId,\r\n      date: this.date,\r\n      quantity: quantity\r\n    }]\r\n  }\r\n\r\n  saveDispensations(dispensations: Array<any>) {\r\n    return AppEncounterService.postJson('/dispensations', { \r\n      dispensations, \r\n      'program_id': AppEncounterService.getProgramID()\r\n    })\r\n  }\r\n\r\n  async voidOrder(orderId: number) {\r\n    return AppEncounterService.void(`/dispensations/${orderId}`, {})\r\n  }\r\n\r\n  async loadDrugHistory() {\r\n    const res = await DrugOrderService.getDrugOrderHistory(this.patientID)\r\n    if (res) {\r\n      this.drugHistory = res\r\n    }\r\n  }\r\n\r\n  async loadCurrentDrugOrder() {\r\n    const res = await DrugOrderService.getDrugOrders(this.patientID)\r\n    if (res) {\r\n      this.currentDrugOrder = await Promise.all(res)        \r\n    }\r\n  }\r\n\r\n  calcCompletePack(drug: any, units: number) {\r\n     //sorting in an ascending order by tabs\r\n    const drugOrderBarcodes = drug.barcodes.sort(function (a: any, b: any) {\r\n      return a.tabs - b.tabs;\r\n    });\r\n    if (drugOrderBarcodes.length == 0 || units == 0.0) {\r\n      return units;\r\n    }\r\n    for (let i = 0; i <= drugOrderBarcodes.length - 1; i++) {\r\n      if (parseInt(drugOrderBarcodes[i].tabs) >= units) {\r\n        return drugOrderBarcodes[i].tabs;\r\n      }\r\n    }\r\n    const smallestAvailableTab = parseInt(drugOrderBarcodes[0].tabs)\r\n    let completePack = parseInt(drugOrderBarcodes[drugOrderBarcodes.length - 1].tabs)\r\n    while (completePack < units) {\r\n      completePack += smallestAvailableTab\r\n    }\r\n    return completePack\r\n  }\r\n}\r\n","\r\nimport { defineComponent } from 'vue'\r\nimport { FieldType } from \"@/components/Forms/BaseFormElements\"\r\nimport { Field, Option } from \"@/components/Forms/FieldInterface\"\r\nimport { toastWarning, alertConfirmation } from \"@/utils/Alerts\"\r\nimport { DispensationService } from \"@/apps/OPD/services/dispensation_service\"\r\nimport EncounterMixinVue from '@/views/EncounterMixin.vue'\r\nimport HisDate from \"@/utils/Date\"\r\n\r\nexport default defineComponent({\r\n  mixins: [EncounterMixinVue],\r\n  data: () => ({\r\n    dispensation: {} as any\r\n  }),\r\n  watch: {\r\n    patient: {\r\n      async handler(patient: any){\r\n        this.dispensation = new DispensationService(patient.getID(), this.providerID)\r\n        await this.dispensation.loadCurrentDrugOrder()\r\n        await this.dispensation.loadDrugHistory()\r\n        this.fields = this.getFields()\r\n      },\r\n      deep: true\r\n    }\r\n  },\r\n  methods: {\r\n    saveDispensations(item: Option) {\r\n      const dispensations = this.buildDispensations(item)\r\n      return this.dispensation.saveDispensations(dispensations)    \r\n    },\r\n    buildDispensations(item: Option) {\r\n      return this.dispensation.buildDispensations(\r\n        item.other.order_id, item.value\r\n      )\r\n    },\r\n    buildMedicationHistory() {\r\n      return this.dispensation.getDrugHistory()\r\n      .sort((a: any, b: any) => {\r\n        const dateA: any = new Date(a.order.start_date)\r\n        const dateB: any = new Date(b.order.start_date)\r\n        return dateB - dateA\r\n      })\r\n      .map((d: any) => ({\r\n        medication: d.drug.name,\r\n        date: HisDate.toStandardHisDisplayFormat(d.order.start_date),\r\n        amount: d.quantity\r\n      }))\r\n    },\r\n    buildOrderOptions() {\r\n      return this.dispensation.getCurrentOrder().map((d: any) => ({\r\n        label: d.drug.name,\r\n        value: d.quantity || 0,\r\n        other: {\r\n          'drug_id': d.drug.drug_id,\r\n          'order_id': d.order.order_id,\r\n          'amount_needed': this.calculateCompletePack(d),\r\n        }\r\n      }))\r\n    },\r\n    getPackSizesRows(drugId: number, availableStock: number) {\r\n      const packs = this.dispensation.getDrugPackSizes(drugId)\r\n      return packs.map((packSize: number) => {\r\n        const packs = availableStock > 0 ? (availableStock / packSize) : '-'\r\n        return [packSize, packs, 0, 0]\r\n      })\r\n    },\r\n    calculateCompletePack(order: any) {\r\n      const units = parseFloat(order.amount_needed) - (order.quantity || 0)\r\n      const completePack = this.dispensation.calcCompletePack(order, units)\r\n      return completePack < 0 ? 0 : completePack\r\n    },\r\n    isDoneDispensing(orders: Array<Option>) {\r\n      return orders.map(o => o.value != 0).every(Boolean)\r\n    },\r\n    async isValidDispensation(option: Option) {\r\n      let isOk = true\r\n      const totalTabs = parseInt(option.value.toString())\r\n      const amountNeeded = option.other['amount_needed']\r\n      const percentageGiven = (totalTabs / amountNeeded) * 100\r\n      if (percentageGiven > 110) {\r\n        isOk = await alertConfirmation('Are you sure you want to dispense over 110% of the prescribed pill count?')\r\n      }\r\n      if (percentageGiven < 100) {\r\n        isOk = await alertConfirmation('Are you sure you want to dispense less than 100% of the prescribe amount?')\r\n      }\r\n      return isOk\r\n    },\r\n    getFields(): Array<Field> {\r\n      return [\r\n        {\r\n          id: 'dispenses',\r\n          helpText: 'Dispensation',\r\n          type: FieldType.TT_DRUG_DISPENSER,\r\n          onValueUpdate: async(i: Option, l: Option[]) => {\r\n            if(i.value != -1 && this.isDoneDispensing(l)) {\r\n              return this.gotoPatientDashboard()\r\n            }\r\n            i.other['amount_needed'] = 0\r\n            await this.dispensation.loadCurrentDrugOrder()\r\n            return this.buildOrderOptions()\r\n          },\r\n          onValue: async (i: Option, isBarcodeScanned: boolean) => {\r\n            if (i.value  === -1) {\r\n              const voided = await this.dispensation.voidOrder(i.other.order_id)\r\n              return voided? true : false\r\n            }\r\n            if (!isBarcodeScanned) {\r\n              const isValidDispensation = await this.isValidDispensation(i)\r\n              if (!isValidDispensation) return false\r\n            }\r\n            const dispensed = await this.saveDispensations(i)\r\n            if (dispensed) return true\r\n            toastWarning('Unable to save dispensation')\r\n            return false\r\n          },\r\n          config: {\r\n            medicationHistory: this.buildMedicationHistory(),\r\n            toolbarInfo: [\r\n              { label: 'Name', value: this.patient.getFullName() },\r\n              { label: 'Gender', value: this.patient.getGender() },\r\n              { label: 'Date Of Birth', value: HisDate.toStandardHisDisplayFormat(\r\n                this.patient.getBirthdate()\r\n              )}\r\n            ],\r\n            hiddenFooterBtns: [ \r\n              'Clear',\r\n              'Finish'\r\n            ]\r\n          },\r\n          options: () => this.buildOrderOptions()\r\n        }\r\n      ]\r\n    }\r\n  }\r\n})\r\n","import { render } from \"./Dispensing.vue?vue&type=template&id=1e367495&ts=true\"\nimport script from \"./Dispensing.vue?vue&type=script&lang=ts\"\nexport * from \"./Dispensing.vue?vue&type=script&lang=ts\"\n\nimport exportComponent from \"C:\\\\Users\\\\msuleman\\\\projects\\\\HIS-Core\\\\node_modules\\\\@vue\\\\cli-service\\\\node_modules\\\\vue-loader-v16\\\\dist\\\\exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render]])\n\nexport default __exports__"],"sourceRoot":""}